<?php

// Bootstrap
chdir($_SERVER['DOCUMENT_ROOT']);
global $base_url;
$base_url = 'http://'.$_SERVER['HTTP_HOST'];
require_once './includes/bootstrap.inc';
require_once './includes/common.inc';
require_once './includes/module.inc';
//drupal_bootstrap(DRUPAL_BOOTSTRAP_SESSION);
//drupal_bootstrap(DRUPAL_BOOTSTRAP_DATABASE);
drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);
drupal_load('module', 'node');
module_invoke('node', 'boot');

// Routine to check all camps on new list and verify correct review ID

$raw = "6472,35435|17271,40183|6229,17409|12701,12799|10229,9397|13293,14563|38191,44201|10231,6075|7522,10665|7836,8461|13781,35606|17115,39401|16778,37593|14100,18549|10268,17131|17683,41823|14312,30911|6142,5115|16714,37441|17750,42081|6459,35423|5374,27530|10452,29728|13563,17909|17049,39167|7455,15789|6244,16209|7011,27492|10586,9621|17053,39171|9944,26048|16895,38057|17832,42507|5647,35281|13661,15609|10289,35298|5942,5195|14238,35852|8226,27011|16640,37143|16931,38183|9836,18611|17047,39165|36116,44181|10765,27817|34158,45701|17194,39721|36320,44501|5862,5577|7144,28595|9967,8173|7237,29000|7049,28614|6236,29984|17242,40021|13280,9387|9163,28654|5939,5161|9044,29741|34085,43201|9414,27525|13507,16129|10689,15249|6277,26609|6186,5483|7269,35767|38119,44481|13865,19329|5919,5855|17008,38841|8316,26872|9880,26329|14283,30149|5811,1067|8568,28924|6727,26055|7638,10337|9418,27806|6997,27349|7530,9529|6887,25831|17030,39101|17861,42661|7074,28625|9221,29272|9283,27402|16955,38421|13579,25677|66595,28784|9893,36047|17599,41429|5853,1147|9641,35819|7092,28632|9040,17169|6573,1075|6099,5811|8935,8275|8510,28732|7274,16649|7390,17569|7630,10326|7338,12829|5966,5575|1248,35450|9345,10336|10423,9495|36132,5375|11591,19549|16867,37881|8877,8401|6323,25968|7229,28594|14042,15335|66239,7921|14232,35659|5894,5607|5743,11511|14087,17189|9881,13777|10223,6281|9365,5249|14275,15209|13758,35276|14163,29201|16436,5443|7193,35748|17665,41777|6866,25693|6867,9951|16830,37785|14031,18651|5750,26264|6035,5487|7653,1047|10012,26182|16610,37021|9307,15873|8222,27005|7048,27505|37080,28692|6401,11555|5908,5623|17073,29080|66346,7861|16845,37805|16617,37041|14161,35785|16755,37579|10306,10947|5619,28195|7513,10650|8160,27140|16789,37567|14373,36527|17317,40461|16832,37789|4576,7829|36031,43581|5904,5269|10207,6277|13672,35792|13629,16509|9242,27542|6268,16469|17818,42557|438,5025|13952,35618|6249,17149|6653,35568|10815,16369|17234,27468|16725,14573|5729,25764|6751,35623|17682,41841|16759,27287|9965,28731|9196,27522|8405,26914|11519,17129|5615,9707|17299,40307|7081,27509|14030,30269|7100,28780|5687,9855|14287,16273|36729,44821|7252,28819|8550,12610|14099,19679|13103,13349|17817,42421|7289,29166|10762,11917|9208,29054|14185,29806|9092,28116|8621,1079|8380,27740|9948,19729|7438,28852|5913,5745|5672,28368|16788,10319|5830,5675|8610,18039|17190,26449|6380,14269|11486,29594|5702,11369|7272,29016|17286,28057|17744,5237|8379,27739|9105,19589|6479,35439|8653,18121|13294,14535|6734,26070|8841,8239|17631,27263|10573,36024|9070,27988|8565,36054|6289,25645|8318,26873|8236,10747|484,5047|9651,15749|7337,29356|6865,19269|16774,18589|8346,27708|8381,26894|6780,26347|10185,14449|10497,28736|9961,26076|8662,7809|7349,11091|10633,35455|8844,7795|5807,5519|13509,17751|8702,7817|13476,18053|6864,26450|7381,29401|14280,5383|14380,36461|6721,35613|6986,25855|6655,9689|13537,13551|10109,29140|7709,35854|6992,27485|6994,13259|6894,35343|7244,11213|7365,29383|7645,10345|8118,27095|7903,13529|8140,16611|13830,16969|5945,5935|17094,39321|5880,5231|7466,28425|6298,25650|6242,27456|39447,43203|7807,28901|4402,36053|8388,26899|7358,29379|8428,26931|66314,15269|10791,27389|10796,27717|9377,11389|7020,27496|16942,38261|5827,1151|6944,25874|14183,29163|17547,26090|14051,29187|7684,27662|8416,18469|17733,27621|13545,13509|14190,26583|7189,28807|6970,25898|6972,35687|8496,13489|7460,28417|7256,28820|9157,27372|39454,25841|17592,41427|6902,25902|7331,29209|16761,37587|5868,5357|17275,25720|8635,15049|7308,29186|17247,40085|6499,13969|17176,39621|7661,10361|16914,11909|14144,35944|6020,5189|14035,18133|7299,15569|10657,28991|6248,15469|5831,5599|17798,42581|10572,35994|7998,28165|17241,40081|14254,10636|4753,42749|13392,35733|13933,19091|16735,37669|10280,29586|10766,27566|8445,36019|7562,10011|7115,35725|8413,36005|10071,8259|9282,27382|8375,27735|66186,14349|6246,14769|13014,13449|16628,37105|8293,5723|7452,28410|10660,35730|10486,9081|7186,11669|7190,26486|7192,28808|8477,26761|17072,39249|17602,41441|7363,29382|16379,36741|8151,27106|6763,26352|6131,16189|16751,29821|9210,27369|16796,37573|8106,28505|9018,29548|17581,41221|8373,27734|17113,39383|6824,26185|7783,28879|8457,26743|6669,35590|8603,36076|7386,29406|13875,35983|39305,27378|6564,28339|8789,8383|10742,35817|8333,13709|10417,27729|9216,27557|7127,28789|7450,35809|6854,19109|8707,8011|12766,35879|7385,29583|6733,26069|9173,27968|10732,29816|16991,38821|14397,36545|7988,28044|10559,26348|7239,28816|9288,27383|8139,27123|6950,25861|6838,26195|8387,26898|9281,28671|13657,35666|7995,28162|6998,35695|6755,26106|16475,28538|9261,27966|7693,13691|6265,26596|10820,35956|16615,37101|12826,12677|7735,35863|9332,26088|6918,25885|6921,25869|14268,19049|6536,35478|9055,10427|7412,29585|9064,17229|16869,37961|14386,36487|13639,29554|7459,28416|8636,18101|16464,36865|7505,10640|8007,13713|7552,10638|8266,18991|5671,28367|6771,26133|8609,18037|6482,35441|16784,37563|8429,26932|7608,10376|8355,27713|7586,35833|9213,27373|6522,35469|16918,38101|8219,27205|6973,25859|8105,14133|9602,14709|7310,35784|14266,13929|7482,28441|38461,40381|6442,35407|8370,27731|7621,10318|8158,35960|6890,25834|5997,5365|6550,35487|8399,10167|6814,26176|13101,35673|5998,5299|6942,35677|9635,27974|9065,27981|9293,27558|9375,29360|10282,29610|7006,27483|6570,35362|8447,30209|7738,28698|6593,35525|8129,27102|17560,41047|14374,36523|9631,36093|7966,27855|34092,45563|8424,26927|16760,28550|10390,14809|8353,27711|8163,27144|9251,27533|8184,10407|6041,1083|7677,10857|7750,28706|6715,26030|8237,13331|6935,35675|6540,35480|14096,29264|6966,25893|9030,13277|5734,25769|7009,27487|8896,8409|6968,15413|8473,26756|66276,30609|6333,35357|6977,25858|8517,13335|7809,28903|7464,11231|66304,7893|10495,35427|8593,13715|6736,12849|6341,25980|7762,28716|7650,10350|8511,36043|6688,29852|5646,28205|7422,12489|6681,28163|8082,28355|8138,11311|10574,27710|6749,26098|10004,8355|9188,27549|5875,5467|7306,29184|8402,26911|10429,28749|9255,27384|9212,27376|8187,27162|13463,27200|10396,17755|6917,25883|7166,13169|8411,36004|13574,29733|6411,10508|17556,35610|5873,5885|8622,18091|8342,13431|9211,27807|10455,8927|9187,28661|6061,5323|9215,27391|9069,13629|16649,27990|7382,29402|7723,13009|7904,7904|8146,27141|7004,27354|8363,27723|8365,27725|7323,13213|7012,27493|34165,9667|8189,13329|8251,14689|6440,16529|8410,36003|9199,28673|36057,44521|6294,10827|16694,37281|7102,35722|6892,25836|6911,25888|13622,35788|5746,12089|6960,25890|8420,36010|7816,13333|16959,38341|6668,12029|13621,35669|16683,38721|8317,14429|6916,25887|8132,27113|9254,28677|17829,14071|7431,29615|8469,26753|7486,14849|6802,26169|6527,13151|8450,26739|8203,10767|6588,35523|8384,26895|8359,27718|8377,27737|8201,27193|6958,35683|9285,28659|9068,27986|9239,27553|6901,25850|17197,27482|39298,29226|39459,45565|6030,5529|6947,25886|16946,19129|8227,27012|6905,25891|6665,35586|7320,29195|6601,35532|36168,43369|8357,27716|6677,35599|7749,28704|6314,25961|8386,10730|8136,27120|5742,25788|17066,5679|17282,40261|7725,28688|7729,11149|17336,25987|6606,35536|5713,26558|6857,25663|10366,26573|8590,14069|5856,5877|7007,27484|7798,28890|8135,27119|10247,27185|7044,28611|9027,29713|9292,27532|6409,35380|9043,29740|6469,35431|17025,25640|36144,10294|8542,12604|7359,26246|7317,29193|7421,29598|17027,26257|17301,40309|17551,41043|9958,16829|16936,38201|7587,36087|5682,35304|13173,18031|442,5037|6034,5157|6752,9987|8265,27892|7473,35813|6497,12409|6276,16049|13278,14183|7920,43681|9023,29704|8354,27712|8449,26515|519,5059|10817,9609|14006,35320|10491,12614|9153,15491|7088,28967|6299,25652|5877,5469|6421,35388|8467,10707|8112,28854|6285,17849|17634,15771|6027,5397|13877,36153|8327,26885|10230,6047|17736,26639|9253,14129|8422,26926|9166,27820|7029,35697|8325,26882|8143,15631|8148,10728|6335,25975|9955,35630|7701,28533|8508,13275|7953,35912|5863,5509|8432,36012|5776,15879|16439,36957|9200,27387|13555,29687|5906,5371|9733,26096|6641,35557|5790,27188|9078,28142|6687,12491|8505,28586|6376,29510|13472,15409|7414,35805|7797,35875|7759,28713|7370,29389|8396,19569|8376,27736|36899,44121|17807,42551|6387,29674|13003,12911|17694,41863|9599,14749|7682,27654|8887,8093|10228,6231|12698,11989|5642,35280|8793,7859|6278,26610|14025,18477|16749,37161|6203,5335|6717,26034|5820,5177|6231,29966|6080,5893|10267,29980|17731,27478|5727,11329|8446,16629|9193,36119|5645,28204|8374,13257|8331,15969|5923,5769|6613,35540|5916,5233|17158,39521|10371,15869|7853,5799|6999,9927|6063,5761|5770,26235|6825,35644|5731,25767|8527,12592|5925,5677|5771,26236|8538,12601|5798,14029|8544,12605";

$raw2 = explode("|", $raw);
foreach ($raw2 as $raw3) {
  $data[] = explode(",", $raw3);
  // 0 = GCA internal ID
  // 1 = Review ID
}

// Get nid, latest vid for each pair

foreach ($data as $key => $value) {
  $final[$key]["user"] = $value[0];
  $final[$key]["uid"] = getCampUID($value[0]);
  $final[$key]["nidvid"] = getCampNID($final[$key]["uid"]);
  $final[$key]["review_id"] = $value[1];
}

updateCampData($final);
echo "DONE.<br />";

function updateCampData($data) {
  foreach ($data as $camp) {
    db_query("UPDATE {content_type_camp} SET field_park_guest_reviews_optin_value = 'yes', field_camp_guestreview_id_value = %d WHERE nid = %d AND vid = %d", $camp["review_id"], $camp["nidvid"]["nid"], $camp["nidvid"]["vid"]);
  }
}

function getCampNID($uid) {
  $query = db_query("SELECT nid, vid FROM {node} WHERE uid = %d ORDER BY vid DESC LIMIT 1", $uid);
  while ($row = db_fetch_array($query)) {
    $result["nid"] = $row["nid"];
	$result["vid"] = $row["vid"];
  }
  if (isset($result)) {
    return $result;
  }
  return FALSE;
}

function getCampUID($user) {
  $query = db_query("SELECT uid FROM {users} WHERE name = '%s' LIMIT 1", $user);
  while ($row = db_fetch_array($query)) {
    $result = $row["uid"];
  }
  if (isset($result)) {
    return $result;
  }
  return FALSE;
}

echo "<pre>";
print_r($final);
echo "</pre>";

?>